<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>ChitChat</title>

    <!-- Mandatory for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>
        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            background: #f4f6f8;
        }

        .app-container {
            display: flex;
            height: calc(100vh - 20px);
            margin: 10px;
            background: #ffffff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* CONTACTS */
        .contacts-panel {
            width: 28%;
            min-width: 240px;
            background: #2f3640;
            color: #fff;
            display: flex;
            flex-direction: column;
        }

        .contacts-header {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #3f4750;
        }

        .contact-item:hover {
            background: #414b57;
        }

        .contact-name {
            font-weight: bold;
        }

        .contact-username {
            font-size: 12px;
            color: #bbb;
        }

        /* CHAT */
        .chat-panel {
            width: 72%;
            display: flex;
            flex-direction: column;
            background: #eef1f5;
        }

        .chat-header {
            padding: 15px;
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .msg {
            max-width: 75%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .msg-sent {
            background: #4facfe;
            color: #fff;
            margin-left: auto;
        }

        .msg-received {
            background: #ffffff;
            color: #333;
            border: 1px solid #ddd;
        }

        .chat-input {
            padding: 10px;
            background: #ffffff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .empty-chat {
            text-align: center;
            margin-top: 120px;
            color: #888;
            font-size: 16px;
        }

        /* TABLET */
        @media (max-width: 900px) {
            .contacts-panel {
                width: 35%;
            }
            .chat-panel {
                width: 65%;
            }
        }

        /* MOBILE */
        @media (max-width: 600px) {
            .app-container {
                flex-direction: column;
                margin: 0;
                height: 100vh;
                border-radius: 0;
            }

            .contacts-panel {
                width: 100%;
                max-height: 35vh;
            }

            .chat-panel {
                width: 100%;
            }

            .chat-header {
                font-size: 14px;
            }

            .msg {
                max-width: 85%;
                font-size: 13px;
            }

            .chat-input {
                flex-direction: column;
            }
        }
    </style>
</h:head>

<h:body>

<f:metadata>
    <f:viewAction action="#{chatBean.init}" />
</f:metadata>

<p:growl id="growl" life="3000" />

<h:form id="mainForm">

    <div class="app-container">

        <!-- CONTACT LIST -->
        <div class="contacts-panel">
            <div class="contacts-header">
                Chats
                <p:commandButton icon="pi pi-plus"
                                 styleClass="ui-button-success ui-button-flat"
                                 onclick="PF('newChatDlg').show();" />
            </div>

            <p:dataList value="#{chatBean.contacts}" var="contact">
                <p:commandLink action="#{chatBean.setSelectedContact(contact)}"
                               update="mainForm">
                    <div class="contact-item">
                        <div class="contact-name">
                            #{contact.firstName} #{contact.lastName}
                        </div>
                        <div class="contact-username">
                            @#{contact.username}
                        </div>
                    </div>
                </p:commandLink>
            </p:dataList>
        </div>

        <!-- CHAT PANEL -->
        <div class="chat-panel">

            <h:panelGroup rendered="#{chatBean.selectedContact != null}">

                <div class="chat-header">
                    <strong>
                        #{chatBean.selectedContact.firstName}
                        #{chatBean.selectedContact.lastName}
                    </strong>

                    <p:commandButton icon="pi pi-trash"
                                     styleClass="ui-button-danger ui-button-flat"
                                     action="#{chatBean.deleteChat}"
                                     update="mainForm"
                                     onclick="return confirm('Delete this conversation?');" />
                </div>

                <div class="chat-messages">
                    <p:dataList value="#{chatBean.messages}" var="msg">
                        <div class="msg #{msg.sender.username eq sessionScope.user.username ? 'msg-sent' : 'msg-received'}">
                            #{msg.message}
                        </div>
                    </p:dataList>
                </div>

                <div class="chat-input">
                    <p:inputTextarea value="#{chatBean.message}"
                                     rows="2"
                                     autoResize="true"
                                     style="width:100%" />

                    <p:commandButton value="Send"
                                     icon="pi pi-send"
                                     action="#{chatBean.send}"
                                     update="mainForm"
                                     styleClass="ui-button-primary" />
                </div>

            </h:panelGroup>

            <h:panelGroup rendered="#{chatBean.selectedContact == null}">
                <div class="empty-chat">
                    Select a chat or start a new conversation
                </div>
            </h:panelGroup>

        </div>
    </div>

    <p:poll interval="3"
            listener="#{chatBean.loadMessages}"
            update="mainForm growl" />

    <p:commandButton value="Logout"
                     icon="pi pi-sign-out"
                     action="#{loginBean.logout}"
                     style="margin:10px;" />

</h:form>

<!-- NEW CHAT DIALOG -->
<p:dialog header="Start New Chat"
          widgetVar="newChatDlg"
          modal="true"
          resizable="false">

    <h:form>
        <p:outputLabel value="Username" />
        <p:inputText value="#{chatBean.newContactUsername}"
                     placeholder="Enter username" />

        <p:commandButton value="Start Chat"
                         icon="pi pi-check"
                         action="#{chatBean.startNewChat}"
                         update=":mainForm"
                         oncomplete="PF('newChatDlg').hide();" />
    </h:form>
</p:dialog>

</h:body>
</html>
